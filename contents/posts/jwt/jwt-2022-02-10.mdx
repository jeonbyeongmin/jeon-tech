---
date: '2022-02-10'
title: 'JWT를 이용한 Auth 방식'
categories: ['knowledge']
summary: 'JWT는 JSON Web Token의 약자로 JSON 형식을 이용하여 웹에서 사용할 수 있는 엑세스 토큰을 다루는 표준입니다. 웹 개발을 공부하는 입장에서 당연히 알아야하는 지식이지만 이제서야 공부를 하게 되었습니다. 왜 인증 방식을 JWT을 채택하게 되었는지와 JWT를 어떻게 보안을 지키며 이용할 수 있는지 알아보겠습니다.'
thumbnail: './images/jwt.png'
---

JWT는 JSON Web Token의 약자로 JSON 형식을 이용하여 웹에서 사용할 수 있는 엑세스 토큰을 다루는 표준입니다. 웹 개발을 공부하는 입장에서 당연히 알아야하는 지식이지만 이제서야 공부를 하게 되었습니다. 왜 인증 방식을 JWT을 채택하게 되었는지와 JWT를 어떻게 보안을 지키며 이용할 수 있는지 알아보겠습니다.



# 세션 기반 인증 방식

HTTP 프로토콜은 두가지 특징을 가지고 있습니다. 바로 Stateless(무상태)와 Connectless(비연결성)입니다. 이런 HTTP 프로토콜의 특징으로 인해 매 통신마다 상태를 유지 않지 않고 당연히 로그인 정보도 기억하지 않습니다. 그래서 유저가 로그인을 했다는 것을 브라우저가 기억하기 위해서 쿠키(Cookie) 혹은 세션(Session)을 이용합니다.

세션을 이용할 때에는 로그인 버튼을 누르면 서버에서 유효성을 검증한 뒤 유저 정보를 서버에 저장합니다. 그리고 클라이언트에 세션 id를 제공하고 이를 클라이언트 공간에 저장하여 사용자 인증이 필요한 요청마다 헤더에 세션 id를 포함하도록 합니다.

### 세션 기반 인증 방식의 한계

세션 기반 인증 방식은 서버 내 메모리에 유저 정보를 저장해야 합니다. 유저가 얼마 없다면 괜찮겠지만 사용자가 늘어날수록 서버의 부담은 늘어날 수밖에 없습니다. 이런 한계를 극복하기 위해서 토큰 기반 인증 방식이 나타났습니다.


# 토큰 기반 인증 방식

토큰 기반 인증 방식은 사용자 인증 정보를 서버에 저장하지 않습니다. 그 대신 토큰에 이 정보를 담고 암호화하여 클라이언트에 전달합니다. 그래서 세션 기반 인증 방식의 한계를 극복하였습니다. 서버에 부하를 주지 않을 뿐만 아니라 여러 서버를 이용하는 환경에서도 문제없이 사용자 인증이 가능합니다.

토큰 기반 인증 방식에서도 보안 문제가 발생합니다. 이런 방식에서는 accessToken을 주기적으로 만료시켜주지만 토큰이 탈취당한 상황에서 토큰이 만료되기 전까지 토큰을 강제로 만료시킬 수 없습니다. 정리하면 토큰은 주기적으로 토큰을 만료시켜주지만, 만료 시기까지는 강제로 만료시킬 수 없다는 특징을 가지고 있습니다.

### JWT(JSON Web Token)

유저가 로그인하면 서버가 인증 정보를 보내줍니다. 암호화나 시그니처 추가가 가능한 패키지 안에 인증 정보를 담아 보내줍니다. 여기에는 accessToken과 refreshToken이 있는데 이것이 이후 유저 인증에 사용되는데 이를 클라이언트에 저장해두고 사용합니다. accessToken은 일정 시간이 지나면 만료되는 특징을 가지고 있습니다. 이때 refreshToken을 이용하여 새로은 accessToken을 발급받습니다.

### JWT의 문제

비단 JWT만의 문제는 아니지만 JWT에서도 XSS(Cross site scripting), CSRF(Cross Site Request Forgery) 보안 문제가 여전히 존재합니다.

> #### XSS <br/>
공격 의도가 있는 악의적인 스크립트를 브라우저에 삽입하여 실행하느 공격이다. 웹의 유효성 검사가 충분하지 않을 경우 브라우저는 스크립트의 악의성을 감별할 수 없다. 공격자는 사용자를 가장하여, 쿠키와 토큰을 탈취하고 사이트 내 민감한 정보들에 접근 가능해진다.

> #### CSRF <br/>
공격자가 브러자우저로 하여금 서버에 어떤 요청을 보내도록 하는 것이다. XSS로 탈취한 정보가 이때 사용될 수 있다. 예를 들어 CSRF에 취약한 은행 사이트가 있다면 공격자는 특정 유저의 계좌에 있는 돈을 모두 타인에게 송금할 수 있을 것이다.

이러한 보안 문제가 발생하는 것은 JWT 방식에서도 결국 토큰을 클라이언트에 저장하기 때문일 것입니다. 클라이언트에서는 보통 localStorage 혹은 쿠키에 저장해두는데, 이것이 XSS과 CSRF에 취약합니다.

# 브라우저에 저장소와 보안 이슈

먼저 어떤 저장 방식을 선택하여도 보안 문제가 존재한다. 이것은 클라이언트 및 서버에서 추가적인 XSS 방어 처리를 통해 해결해야 할 것이다.

### localStorage 저장 방식

브라우저 저장소에 저장하는 방식이다. 자바스크립트 내 글로벌 변수로 읽기 / 쓰기 접근이 가능하다. 따라서 XSS, CSRF 취약점이 있을 경우 보안 이슈가 발생한다.

### 쿠키 저장 방식

쿠키 저장 방식도 마찬가지로 자바스크립트 내 글로벌 변수로 읽기 / 쓰기 접근이 가능하다. 따라서 XSS, CSRF 취약점이 있을 경우 보안 이슈가 발생한다.

### secure, httpOnly 쿠키 저장 방식

브라우저에 쿠키로 저장되는 것은 같지만, 자바스크립트 내에서 접근이 불가능하다. secure를 적용하면 https 접속에서만 동작한다. 따라서 이전 방법들에 비해 보안 문제가 적다고 볼 수 있다. 하지만 완전히 자유로운 것은 아니다. httpOnly 쿠키에 담긴 값에 접근은 불가능하지만 XSS 취약점을 노려 API 콜을 요쳥하면 httpOnly 쿠키도 함께 보내진다.


# 결론

결론은 서버 부하를 막기 위해서도, 보안 위험요소를 줄이기 위해서도 세션 기반 인증 방식보단 JWT를 이용하는 것이 좋다. 또한 refreshToken만을 httpOnly 쿠키에 저장하고 accessToken은 브라우저에 저장하지 않고 로컬 변수에 저장해 사용하는 방식으로 CSRF 공격을 방어할 수 있다. 이렇게 CSRF 취약점을 방어할 수 있어도 XSS는 완전 방어할 수 없다. 따라서 클라이언트와 서버에서 추가적으로 XSS 취약점을 막을 필요가 있다.
